
# This is the server logic for a Shiny web application.
# You can find out more about building applications with Shiny here:
#
# Create the basic profiling information using the "eagle_profile.submit" and "eagle_profile.slurm.template" scripts
# e.g. sbatch eagle_profile.submit <ngpu> 
# Now use sort and tail to remove the extra header strings "profile,itnum,ncpu,ngpu,function,time_ms"
# cat eagle_11710257_*.res | grep profile | sort -h -r | tail -n +9


library(shiny)
library(shinyFiles)
library(rbokeh)

shinyServer(function(input, output, session) {
  flush1    <- Sys.getenv("FLUSH1DIR")
  flush1 <- ".."
  output$fi_text <- renderText({
    filePath <- input$fi_file$datapath
    # fileText <- paste(readLines(filePath), collapse = "\n")
    # fileText
    filePath
  })
  
  # volumes <- c('Home directory'='/flush1/bow355')
  volumes <- c('Home directory'=flush1)
  shinyFileChoose(input, 'files', root=volumes, session=session, filetypes=c('', 'txt')) 
  
  output$filepaths  <- renderPrint({
    testfile <-  parseFilePaths(volumes,input$files)[["datapath"]]
    fileText <- ""

    if (file.exists(as.character(testfile[1]))) {
       fileText <- paste(readLines(as.character(testfile[1])), collapse = " ")
    }
    fileText
  }) 
  
  output$rbokeh <- renderRbokeh({
    figure() %>% ly_points(1:10) %>%
      x_range(callback = shiny_callback("x_range"))
  })
  
})

