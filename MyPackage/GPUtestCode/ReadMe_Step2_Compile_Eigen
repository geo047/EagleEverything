# Run R
# purge and load modules to set up enviro variables
# this needs to run in R

# set up LD_LIBRARY_PATH variable 
## ====> Do this First ====> export LD_LIBRARY_PATH=$MAGMA_HOME/lib:$CUDA_HOME/lib64:$INTEL_MKL_HOME/lib/
##                           export OMP_NUM_THREADS=16  
library(Rcpp)
MAGMA_HOME <- "/apps/magma/2.5.1a1-ipl64-cuda90"
CUDA_HOME <- "/apps/cuda/9.0.176/"
INTEL_MKL_HOME <-    "/apps/intel/mkl/2017.2.174/compilers_and_libraries_2017.2.174/linux/mkl"
#### ======>     export LD_LIBRARY_PATH=$MAGMA_HOME/lib:$CUDA_HOME/lib64:$INTEL_MKL_HOME/lib/

PKG_LIBS  <- sprintf( ' -L%s/lib  -lmagma  -L%s/lib/intel64_lin  -lmkl_intel_ilp64  -L%s/../compiler/lib/intel64_lin  -liomp5 ', MAGMA_HOME, INTEL_MKL_HOME, INTEL_MKL_HOME)
PKG_CPPFLAGS  <- sprintf('    -I%s/include  -I%s/include   -DMAGMA_ILP64 -DMKL_ILP64       ', MAGMA_HOME, CUDA_HOME)

Sys.setenv(PKG_LIBS = PKG_LIBS , PKG_CPPFLAGS = PKG_CPPFLAGS)
 sourceCpp("RcppExampleEigen_m_v2.cpp", rebuild=TRUE, verbose=TRUE)

set.seed(100)
n_row <- 300; n_col <- 300
A <- matrix(rnorm(n_row * n_col), n_row, n_col)
A <- tcrossprod(A)    ##  gives me a symmetric matrix
#A <- diag(A)
#A <- diag(A)
eigenA_MAGMA  <- gpuEigen_magma(A)  ## note  this replaces A with the answers ... 


start.time <- Sys.time()
eigenA_R <- eigen(A)
end.time <- Sys.time()
print(end.time - start.time)
summary( sort(eigenA_MAGMA$values) -  sort(eigenA_R$values))
indx <- order(eigenA_R$values)
summary( as.vector(  abs(eigenA_MAGMA$vectors) - abs(eigenA_R$vectors[,indx]) ) )







